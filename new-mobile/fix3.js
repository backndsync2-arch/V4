const fs = require('fs');
let c = fs.readFileSync('lib/main.dart', 'utf8');
let n = 0;

function rep(desc, a, b) {
  if (c.includes(a)) { c = c.replace(a, b); n++; console.log('✓ ' + desc); }
  else console.log('✗ SKIP: ' + desc);
}

// ══════════════════════════════════════════════════════
// FIX 1: Always start announcement loop — don't block on player.playing
// The player takes time to buffer. Start loop + set playback state always.
// ══════════════════════════════════════════════════════
rep('Fix: always start announcement loop',
  "          // Wait a bit and check if actually playing\r\n          await Future.delayed(const Duration(milliseconds: 500));\r\n          final isActuallyPlaying = pm.player.playing;\r\n          print('After playUrls, player.playing: $isActuallyPlaying');\r\n\r\n          if (mounted) setState(() => _playbackState = {'is_playing': isActuallyPlaying});\r\n          if (isActuallyPlaying) {\r\n            _playbackStartTime = DateTime.now();\r\n            _startAnnouncementLoop();\r\n            ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Local playback started')));\r\n          } else {\r\n            ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Playback started but not playing - check URLs')));\r\n          }",
  "          // Start announcement loop immediately — don't wait for player.playing\r\n          _playbackStartTime = DateTime.now();\r\n          _startAnnouncementLoop();\r\n          if (mounted) setState(() => _playbackState = {'is_playing': true});\r\n          ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Playback started ✓'), duration: Duration(seconds: 2)));\r\n          // Verify after short delay\r\n          await Future.delayed(const Duration(milliseconds: 1200));\r\n          final isActuallyPlaying = pm.player.playing;\r\n          print('After playUrls, player.playing: $isActuallyPlaying');\r\n          if (!isActuallyPlaying && mounted) {\r\n            ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Note: buffering audio - may take a moment')));\r\n          }"
);

// ══════════════════════════════════════════════════════
// FIX 2: Status cards - make compact, don't hide bottom content
// Replace the large status cards Builder with a compact version
// ══════════════════════════════════════════════════════
// The current cards are placed above sliders but are quite tall.
// Make them more compact and put them INSIDE a smaller container.
rep('Fix: compact status cards + reduce height',
  "                      return Column(children: [\r\n                        Row(crossAxisAlignment: CrossAxisAlignment.start, children: [\r\n                          Expanded(child: Container(\r\n                            padding: const EdgeInsets.all(12),\r\n                            decoration: BoxDecoration(color: const Color(0xFF1A1A1A), borderRadius: BorderRadius.circular(10), border: Border.all(color: const Color(0xFF1DB954).withOpacity(0.4))),\r\n                            child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [\r\n                              Row(children: [Container(width:22,height:22,decoration:BoxDecoration(color:const Color(0xFF1DB954),borderRadius:BorderRadius.circular(5)),child:const Icon(Icons.music_note,color:Colors.black,size:13)), const SizedBox(width:6), const Text('Now Playing',style:TextStyle(fontWeight:FontWeight.bold,fontSize:12,color:Colors.white))]),\r\n                              const SizedBox(height:6),\r\n                              Text(nowTitle2,style:const TextStyle(fontSize:13,color:Colors.white,fontWeight:FontWeight.w500),maxLines:2,overflow:TextOverflow.ellipsis),\r\n                              const SizedBox(height:3),\r\n                              Text('Track \${idx2+1} of \$total2 · Looping',style:const TextStyle(fontSize:11,color:Color(0xFF1DB954))),\r\n                              const SizedBox(height:4),\r\n                              Row(children:[const Icon(Icons.timer_outlined,size:12,color:Colors.grey),const SizedBox(width:3),Text('\$hh2:\$mm2s:\$ss2',style:const TextStyle(fontSize:11,color:Colors.grey))]),\r\n                            ]),\r\n                          )),\r\n                          const SizedBox(width:10),\r\n                          Expanded(child: Container(\r\n                            padding: const EdgeInsets.all(12),\r\n                            decoration: BoxDecoration(color: const Color(0xFF1A1A1A), borderRadius: BorderRadius.circular(10), border: Border.all(color: _isPlayingAnnouncement?Colors.orange.withOpacity(0.5):const Color(0xFF2A5A3A).withOpacity(0.5))),\r\n                            child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [\r\n                              Row(children: [Container(width:22,height:22,decoration:BoxDecoration(color:_isPlayingAnnouncement?Colors.orange:const Color(0xFF2A5A3A),borderRadius:BorderRadius.circular(5)),child:const Icon(Icons.campaign,color:Colors.white,size:13)), const SizedBox(width:6), Expanded(child:Text(_isPlayingAnnouncement?'Broadcasting':'Next Ann.',overflow:TextOverflow.ellipsis,style:const TextStyle(fontWeight:FontWeight.bold,fontSize:12,color:Colors.white)))]),\r\n                              const SizedBox(height:6),\r\n                              Text(nextAnnName2,style:const TextStyle(fontSize:12,color:Colors.white),maxLines:2,overflow:TextOverflow.ellipsis),\r\n                              const SizedBox(height:4),\r\n                              Container(padding:const EdgeInsets.symmetric(horizontal:6,vertical:3),decoration:BoxDecoration(color:_isPlayingAnnouncement?Colors.orange.withOpacity(0.15):const Color(0xFF1E3A2A),borderRadius:BorderRadius.circular(5)),\r\n                                child:Row(mainAxisSize:MainAxisSize.min,children:[Icon(_isPlayingAnnouncement?Icons.volume_up:Icons.access_time,size:11,color:_isPlayingAnnouncement?Colors.orange:const Color(0xFF1DB954)),const SizedBox(width:3),Text(_isPlayingAnnouncement?'Playing...':'In \$mm2c:\$ss2c',style:TextStyle(fontSize:11,color:_isPlayingAnnouncement?Colors.orange:const Color(0xFF1DB954),fontWeight:FontWeight.bold))])),\r\n                              if (candidates2.length>1) ...[const SizedBox(height:3),Text('\${candidates2.length-1} more',style:const TextStyle(fontSize:10,color:Colors.grey))],\r\n                              const SizedBox(height:6),\r\n                              SizedBox(width:double.infinity,height:28,child:OutlinedButton(onPressed:_isPlayingAnnouncement?null:_playNextAnnouncement,style:OutlinedButton.styleFrom(foregroundColor:const Color(0xFF1DB954),side:const BorderSide(color:Color(0xFF1DB954)),padding:EdgeInsets.zero),child:const Text('Play Now',style:TextStyle(fontSize:11)))),\r\n                            ]),\r\n                          )),\r\n                        ]),\r\n                        const SizedBox(height:16),\r\n                      ]);",
  "                      return Container(\r\n                        margin: const EdgeInsets.only(bottom: 12),\r\n                        padding: const EdgeInsets.all(10),\r\n                        decoration: BoxDecoration(color: const Color(0xFF1A1A1A), borderRadius: BorderRadius.circular(10),\r\n                          border: Border.all(color: _isPlayingAnnouncement ? Colors.orange.withOpacity(0.4) : const Color(0xFF1DB954).withOpacity(0.3))),\r\n                        child: Row(children: [\r\n                          // Now playing info\r\n                          Expanded(child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [\r\n                            Row(children: [const Icon(Icons.music_note, color: Color(0xFF1DB954), size: 14), const SizedBox(width: 4),\r\n                              Expanded(child: Text(nowTitle2, style: const TextStyle(fontSize: 12, color: Colors.white, fontWeight: FontWeight.w600), maxLines: 1, overflow: TextOverflow.ellipsis))]),\r\n                            const SizedBox(height: 2),\r\n                            Text('Track \${idx2+1}/\$total2  ·  \$hh2:\$mm2s:\$ss2', style: const TextStyle(fontSize: 10, color: Colors.grey)),\r\n                          ])),\r\n                          const SizedBox(width: 8),\r\n                          // Announcement countdown\r\n                          Container(padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 6),\r\n                            decoration: BoxDecoration(color: _isPlayingAnnouncement ? Colors.orange.withOpacity(0.15) : const Color(0xFF1E3A2A), borderRadius: BorderRadius.circular(8)),\r\n                            child: Column(mainAxisSize: MainAxisSize.min, children: [\r\n                              Row(mainAxisSize: MainAxisSize.min, children: [\r\n                                Icon(_isPlayingAnnouncement ? Icons.campaign : Icons.access_time, size: 12, color: _isPlayingAnnouncement ? Colors.orange : const Color(0xFF1DB954)),\r\n                                const SizedBox(width: 3),\r\n                                Text(_isPlayingAnnouncement ? 'On Air' : '\$mm2c:\$ss2c', style: TextStyle(fontSize: 11, color: _isPlayingAnnouncement ? Colors.orange : const Color(0xFF1DB954), fontWeight: FontWeight.bold)),\r\n                              ]),\r\n                              if (!_isPlayingAnnouncement && candidates2.isNotEmpty)\r\n                                Text(nextAnnName2.length > 12 ? nextAnnName2.substring(0,12)+'...' : nextAnnName2, style: const TextStyle(fontSize: 9, color: Colors.grey)),\r\n                            ]),\r\n                          ),\r\n                        ]),\r\n                      );"
);

fs.writeFileSync('lib/main.dart.tmp', c, 'utf8');
const o=(c.match(/{/g)||[]).length, cl=(c.match(/}/g)||[]).length;
const op=(c.match(/\(/g)||[]).length, cp=(c.match(/\)/g)||[]).length;
console.log('Braces:', o-cl, 'Parens:', op-cp, '| Fixes:', n);

